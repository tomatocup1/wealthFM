<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ë‹¨ê³¨ì„ ë§Œë“œëŠ” ë¦¬ë·° ê´€ë¦¬ì˜ ë¹„ë²• - ë¶€ì˜ ì •ì„</title>
  
  <!-- React & ReactDOM (CDN) -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>

  <!-- Babel (in-browser) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Supabase (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    /* ì‹¤ì œ í”„ë¡œì íŠ¸ í‚¤ë¡œ êµì²´í•´ ì‚¬ìš© */
    const SUPABASE_URL = "https://xyzysbfukemhbmprtzto.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh5enlzYmZ1a2VtaGJtcHJ0enRvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzYxNTg4NjIsImV4cCI6MjA1MTczNDg2Mn0.DTRZM9WcXNhILGGGL4BJR40-snEh6Fna008hAGsExbY";
    window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>

  <!-- í°íŠ¸ (ì„ íƒì‚¬í•­) -->
  <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">

  <style>
    /* ===== 1. CSS ë³€ìˆ˜ & ê¸°ë³¸ ìŠ¤íƒ€ì¼ ===== */
    :root {
      --primary-color: #FFB6C1;
      --secondary-color: #FFF0F5;
      --accent-color: #1b2024;
      --text-color: #1f1010;
      --heading-color: #1b2024;
      --background-color: #FFFAF0;
      --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
      --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
      --border-radius: 0.5rem;
      --spacing-sm: 0.5rem;
      --spacing-md: 1rem;
      --spacing-lg: 1.5rem;
    }

    body {
      font-family: 'Arial', sans-serif;
      background-color: var(--background-color);
      margin: 0;
      padding: 0;
      line-height: 1.6;
    }

    /* ===== 2. ë„¤ë¹„ê²Œì´ì…˜ ===== */
    .navbar {
      background-color: #ffffff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 1rem;
      position: fixed;
      width: 100%;
      top: 0;
      z-index: 1000;
    }

    .nav-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    .nav-brand {
      font-size: 1.5rem;
      font-weight: bold;
      color: #1b2024;
    }

    .nav-menu {
      display: flex;
      gap: 2rem;
    }

    .nav-link {
      text-decoration: none;
      color: #1f1010;
      padding: 0.5rem;
      font-size: 1.1rem;
      transition: color 0.3s;
    }

    .nav-link:hover {
      color: #1b2024;
    }

    .nav-link.active {
      color: #1b2024;
      border-bottom: 2px solid #1b2024;
    }

    .role-select {
      padding: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: 'Arial', sans-serif;
    }

    /* ===== 3. ë©”ì¸ ì½˜í…ì¸  ===== */
    .main-content {
      margin-top: 80px;
      padding: var(--spacing-lg);
      max-width: 1200px;
      margin-left: auto;
      margin-right: auto;
    }

    .dashboard-container {
      background: white;
      border-radius: var(--border-radius);
      padding: var(--spacing-lg);
      box-shadow: var(--shadow-md);
    }

    /* ë‹¬ë ¥ ê´€ë ¨ */
    .calendar {
      background: white;
      padding: var(--spacing-md);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-md);
      margin-bottom: var(--spacing-lg);
    }
    .calendar td, .calendar th {
      text-align: center;
      border: 1px solid #eee;
      padding: 8px;
    }
    .calendar td:hover {
      background-color: #f0f0f0;
      cursor: pointer;
    }
    .calendar td.selected {
      background-color: var(--accent-color);
      color: #fff;
    }

    @media (max-width: 768px) {
      .nav-menu {
        display: none;
      }
      .main-content {
        padding: var(--spacing-sm);
      }
    }

    @media (max-width: 480px) {
      /* í•„ìš”í•˜ë©´ ì¶”ê°€ ë°˜ì‘í˜• */
    }
  </style>
</head>

<body>
  <!-- ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
  <nav class="navbar">
    <div class="nav-content">
      <div class="nav-brand">ë¶€ì˜ ì •ì„</div>
      <div class="nav-menu" id="navMenu">
        <a href="layout.html" class="nav-link">ë¦¬ë·° ëª¨ì•„ë³´ê¸°</a>
        <a href="customer_data.html" class="nav-link">ê³ ê° ë°ì´í„° ê´€ë¦¬</a>
        <a href="error_logs.html" class="nav-link">ì—ëŸ¬ ë¡œê·¸</a>
      </div>
      <select class="role-select" id="roleSelect">
        <option value="webmaster">ì›¹ë§ˆìŠ¤í„°</option>
        <option value="admin">ê´€ë¦¬ì</option>
        <option value="franchise">í”„ë Œì°¨ì´ì¦ˆ</option>
        <option value="owner">ì ì£¼ë‹˜</option>
      </select>
    </div>
  </nav>

  <!-- ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ -->
  <main class="main-content">
    <div id="review-dashboard-root"></div>
  </main>

  <!-- React ì½”ë“œ (in-browser Babel) -->
  <script type="text/babel">
    const { useState, useEffect } = React;

    // 1) UTC -> í•œêµ­ì‹œê° ë³€í™˜ í•¨ìˆ˜
    function formatKoreanTime(utcString) {
      if (!utcString) return '';
      return new Date(utcString).toLocaleString('ko-KR', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false,
        timeZone: 'Asia/Seoul'
      });
    }

    // 2) ë¦¬ë·° ì¹´ë“œ ì»´í¬ë„ŒíŠ¸
    function ReviewCard({ review }) {
      // ë³„ì  ì‹œê°í™”
      const renderStars = (rating) => {
        return "â­".repeat(rating);
      };

      // í”Œë«í¼ ìƒ‰ìƒ
      const getPlatformColor = (platform) => {
        switch(platform) {
          case "ë°°ë¯¼": return "bg-blue-100";
          case "ì¿ íŒ¡": return "bg-orange-100";
          case "ìš”ê¸°ìš”": return "bg-red-100";
          default: return "bg-gray-100";
        }
      };

      return (
        <div className="bg-white rounded-2xl p-6 shadow-lg hover:shadow-xl transition-shadow duration-300 border border-gray-100">
          <div className="flex items-center justify-between mb-4">
            <div className="flex items-center gap-3">
              <span className="font-bold text-lg text-gray-800">
                {review.store_name}
              </span>
              <span className={`px-3 py-1 rounded-full text-sm ${getPlatformColor(review.platform)}`}>
                {review.platform}
              </span>
              {/* ì‘ì„±ì (reviewer) í‘œì‹œ */}
              {review.reviewer && (
                <span className="text-blue-600 bg-blue-50 px-3 py-1 rounded-full text-sm">
                  {review.reviewer}
                </span>
              )}
            </div>
            {/* ë‚ ì§œ/ì‹œê°„: UTC -> í•œêµ­ì‹œê° */}
            <span className="text-gray-600">
              {formatKoreanTime(review.review_date)}
            </span>
          </div>

          {/* ë³„ì  */}
          <div className="mb-3 text-xl">
            {renderStars(review.star_rating)}
            <span className="ml-2 text-sm text-gray-600">
              {review.star_rating}ì 
            </span>
          </div>

          {/* ì£¼ë¬¸ ë©”ë‰´ */}
          <div className="mb-3 px-4 py-2 bg-purple-50 rounded-full inline-block">
            ğŸ½ï¸ {review.order_menu}
          </div>

          {/* ë¦¬ë·° ë‚´ìš© (ì¤„ë°”ê¿ˆ ì ìš©) */}
          <div className="my-4 text-gray-700 bg-gray-50 p-4 rounded-xl whitespace-pre-line">
            {review.review_text}
          </div>

          {/* AI ë‹µê¸€ (ì¤„ë°”ê¿ˆ ì ìš©) */}
          {review.ai_reply && (
            <div className="mt-4 p-4 bg-yellow-50 rounded-xl border border-yellow-100">
              <div className="flex items-center gap-2 mb-2">
                <span className="text-yellow-600 font-bold">ğŸ’Œ ì‚¬ì¥ë‹˜ ë‹µê¸€</span>
              </div>
              <div className="text-gray-700 whitespace-pre-line">
                {review.ai_reply}
              </div>
            </div>
          )}
        </div>
      );
    }

    // 3) ì „ì²´ ëŒ€ì‹œë³´ë“œ
    function ReviewDashboard() {
      const [stores, setStores] = useState([]);
      const [reviews, setReviews] = useState([]);
      const [selectedStore, setSelectedStore] = useState("all");
      const [selectedPlatform, setPlatform] = useState("all");
      const [selectedDate, setSelectedDate] = useState(new Date());
      const [userRole, setUserRole] = useState("");
      const [statistics, setStatistics] = useState({
        ratings: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 }
      });
      const [loading, setLoading] = useState(true);

      // ë‹¬ë ¥
      const [currentMonth, setCurrentMonth] = useState(new Date());
      const [selectedDay, setSelectedDay] = useState(new Date());

      // í˜ì´ì§€ ë¡œë“œ ì‹œ: ì‚¬ìš©ì ì •ë³´ & ê°€ê²Œ ëª©ë¡
      useEffect(() => {
        const userInfo = sessionStorage.getItem("userInfo");
        if (userInfo) {
          const parsed = JSON.parse(userInfo);
          setUserRole(parsed.role);
          loadStores(parsed.role, parsed.id);
        }
      }, []);

      // 3-1) ê°€ê²Œ ëª©ë¡ ë¡œë“œ
      async function loadStores(role, userId) {
        try {
          let query = window.supabase
            .from("customer_data")
            .select("store_code, store_name");

          switch (role) {
            case "admin":
              query = query.eq("admin_id", userId);
              break;
            case "franchise":
              query = query.eq("franchise_id", userId);
              break;
            case "owner":
              query = query.eq("store_code", userId);
              break;
            default:
              // webmaster -> ì „ì²´
              break;
          }

          const { data, error } = await query.order("store_name");
          if (error) throw error;
          setStores(data || []);
        } catch (err) {
          console.error("ê°€ê²Œ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:", err);
        }
      }

      // 3-2) ë‹¬ë ¥ ìƒì„±
      function generateCalendar(date) {
        const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
        const lastDay = new Date(date.getFullYear(), date.getMonth() + 1, 0);
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - startDate.getDay());

        const weeks = [];
        let currentWeek = [];

        for (let day = new Date(startDate); day <= lastDay; day.setDate(day.getDate() + 1)) {
          if (currentWeek.length === 7) {
            weeks.push(currentWeek);
            currentWeek = [];
          }
          currentWeek.push(new Date(day));
        }

        while (currentWeek.length < 7) {
          const nextDay = new Date(currentWeek[currentWeek.length - 1]);
          nextDay.setDate(nextDay.getDate() + 1);
          currentWeek.push(nextDay);
        }
        weeks.push(currentWeek);

        return weeks;
      }

      // 3-3) ë‹¬ë ¥ ë‚ ì§œ ì„ íƒ
      function handleDateSelect(date) {
        setSelectedDay(date);
        setSelectedDate(date);
        loadReviews(date);
      }

      // 3-4) ë¦¬ë·° ë¡œë“œ
      // DBê°€ date íƒ€ì…ì´ë©´ eq('YYYY-MM-DD')ë¡œ ì¶©ë¶„í•˜ì§€ë§Œ,
      // timestamp with time zone(UTC)ë¼ë©´ ì•„ë˜ [ë°©ë²• B]ì²˜ëŸ¼ ë²”ìœ„ ì¿¼ë¦¬ê°€ í•„ìš”.
      useEffect(() => {
        loadReviews(selectedDate);
        // eslint-disable-next-line
      }, [selectedStore, selectedPlatform]);

      async function loadReviews(date) {
        try {
          setLoading(true);

          // [ë°©ë²• A: date íƒ€ì…ì¼ ë•Œ]
          const formattedDate = date.toISOString().split("T")[0];
          let query = window.supabase
            .from("review_data")
            .select("*")
            .eq("review_date", formattedDate);

          // [ë°©ë²• B: UTC ë²”ìœ„ ì¡°íšŒ - ì£¼ì„ì²˜ë¦¬. DBê°€ timestamptzì¼ ë•Œ ì‚¬ìš© ê°€ëŠ¥]
          // const startKST = new Date(date.getFullYear(), date.getMonth(), date.getDate(), 0, 0, 0);
          // const endKST = new Date(date.getFullYear(), date.getMonth(), date.getDate(), 23, 59, 59);
          // const startUtc = startKST.toISOString();
          // const endUtc = endKST.toISOString();
          // let query = window.supabase
          //   .from("review_data")
          //   .select("*")
          //   .gte("review_date", startUtc)
          //   .lte("review_date", endUtc);

          if (selectedStore !== "all") {
            query = query.eq("store_code", selectedStore);
          }
          if (selectedPlatform !== "all") {
            query = query.eq("platform", selectedPlatform);
          }

          const { data, error } = await query;
          if (error) throw error;

          setReviews(data || []);
          updateStatistics(data || []);
        } catch (err) {
          console.error("ë¦¬ë·° ë¡œë“œ ì‹¤íŒ¨:", err);
        } finally {
          setLoading(false);
        }
      }

      // 3-5) ë³„ì  í†µê³„ ì—…ë°ì´íŠ¸
      function updateStatistics(reviewData) {
        const newStats = {
          ratings: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 }
        };
        reviewData.forEach((r) => {
          const rating = parseInt(r.star_rating, 10);
          if (rating >= 1 && rating <= 5) {
            newStats.ratings[rating] += 1;
          }
        });
        setStatistics(newStats);
      }

      // 3-6) ë‚ ì§œë¥¼ í•œê¸€ë¡œ ì˜ˆì˜ê²Œ í‘œì‹œ
      function formatDate(date) {
        return new Date(date).toLocaleDateString("ko-KR", {
          year: "numeric",
          month: "long",
          day: "numeric"
        });
      }

      return (
        <div className="dashboard-container p-6">
          {/* ë‹¬ë ¥ */}
          <div className="bg-white rounded-lg p-6 shadow-md mb-6">
            <h2 className="text-xl font-bold mb-4">ë‚ ì§œ ì„ íƒ</h2>
            <div className="mb-4 flex justify-between items-center">
              <button
                onClick={() => {
                  const prev = new Date(currentMonth);
                  prev.setMonth(prev.getMonth() - 1);
                  setCurrentMonth(prev);
                }}
                className="px-4 py-2 bg-gray-100 rounded hover:bg-gray-200"
              >
                ì´ì „ ë‹¬
              </button>
              <div className="text-lg font-bold">
                {currentMonth.toLocaleDateString("ko-KR", {
                  year: "numeric",
                  month: "long",
                })}
              </div>
              <button
                onClick={() => {
                  const next = new Date(currentMonth);
                  next.setMonth(next.getMonth() + 1);
                  setCurrentMonth(next);
                }}
                className="px-4 py-2 bg-gray-100 rounded hover:bg-gray-200"
              >
                ë‹¤ìŒ ë‹¬
              </button>
            </div>
            <div className="grid grid-cols-7 gap-1">
              {["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "].map((day) => (
                <div key={day} className="text-center font-bold py-2">
                  {day}
                </div>
              ))}
              {generateCalendar(currentMonth).flat().map((dateObj, idx) => {
                const isCurrentMonth = (dateObj.getMonth() === currentMonth.getMonth());
                const isSelected = (dateObj.toDateString() === selectedDay.toDateString());
                return (
                  <div
                    key={idx}
                    onClick={() => handleDateSelect(dateObj)}
                    className={`
                      text-center p-2 cursor-pointer rounded
                      ${isCurrentMonth ? "text-gray-800" : "text-gray-400"}
                      ${isSelected ? "bg-blue-500 text-white" : "hover:bg-gray-100"}
                    `}
                  >
                    {dateObj.getDate()}
                  </div>
                );
              })}
            </div>
          </div>

          {/* ê°€ê²Œ ì„ íƒ (owner ì œì™¸) */}
          {userRole !== "owner" && (
            <select
              className="w-full p-2 mb-4 border rounded"
              value={selectedStore}
              onChange={(e) => setSelectedStore(e.target.value)}
            >
              <option value="all">ì „ì²´ ê°€ê²Œ</option>
              {stores.map((store) => (
                <option key={store.store_code} value={store.store_code}>
                  {store.store_name}
                </option>
              ))}
            </select>
          )}

          {/* ë³„ì  í†µê³„ */}
          <div className="bg-white rounded-lg p-6 shadow-md mb-6">
            <h2 className="text-xl font-bold mb-4">ë³„ì  í†µê³„</h2>
            <div className="grid grid-cols-5 gap-4">
              {[5,4,3,2,1].map((rating) => (
                <div key={rating} className="text-center p-4 bg-gray-50 rounded-lg">
                  <div className="text-2xl font-bold">
                    {statistics.ratings[rating]}
                  </div>
                  <div className="text-gray-600">
                    {rating}ì 
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* í”Œë«í¼ í•„í„° */}
          <div className="flex gap-4 mb-6">
            {["all", "ë°°ë¯¼", "ì¿ íŒ¡", "ìš”ê¸°ìš”"].map((platform) => (
              <button
                key={platform}
                onClick={() => setPlatform(platform)}
                className={`
                  px-4 py-2 rounded-lg
                  ${selectedPlatform === platform ? "bg-gray-800 text-white" : "bg-white"}
                `}
              >
                {platform === "all" ? "ì „ì²´" : platform}
              </button>
            ))}
          </div>

          {/* ë¦¬ë·° ëª©ë¡ */}
          <div className="space-y-4">
            <h3 className="text-lg font-bold mb-4">
              {formatDate(selectedDate)} ë¦¬ë·°
            </h3>
            {loading ? (
              <div className="text-center py-8">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            ) : reviews.length === 0 ? (
              <div className="text-center py-8">ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
            ) : (
              reviews.map((review, i) => (
                <ReviewCard key={i} review={review} />
              ))
            )}
          </div>
        </div>
      );
    }

    // 4) ë Œë”ë§
    const rootElement = document.getElementById("review-dashboard-root");
    const root = ReactDOM.createRoot(rootElement);
    root.render(<ReviewDashboard />);
  </script>

  <!-- ë„¤ë¹„ê²Œì´ì…˜ ê¶Œí•œ ê´€ë¦¬ -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const userRaw = sessionStorage.getItem("userInfo") || "{}";
      let userInfo;
      try {
        userInfo = JSON.parse(userRaw);
      } catch(e) {
        userInfo = {};
      }

      const navMenu = document.getElementById("navMenu");

      // ë¡œê·¸ì¸ ì•ˆ ë˜ì–´ ìˆìœ¼ë©´ login.htmlë¡œ
      if (!userInfo.role) {
        window.location.href = "login.html";
      } else {
        updateMenuByRole(userInfo.role);
      }

      function updateMenuByRole(role) {
        let menuLinks = `<a href="layout.html" class="nav-link">ë¦¬ë·° ëª¨ì•„ë³´ê¸°</a>`;
        if (role === "webmaster" || role === "admin") {
          menuLinks += `<a href="customer_data.html" class="nav-link">ê³ ê° ë°ì´í„° ê´€ë¦¬</a>`;
        }
        if (role === "webmaster") {
          menuLinks += `<a href="error_logs.html" class="nav-link">ì—ëŸ¬ ë¡œê·¸</a>`;
        }

        navMenu.innerHTML = menuLinks;

        // í˜„ì¬ í˜ì´ì§€ í™œì„±í™”
        const currentPage = window.location.pathname.split("/").pop();
        const menuItems = navMenu.querySelectorAll(".nav-link");
        menuItems.forEach((item) => {
          if (item.getAttribute("href") === currentPage) {
            item.classList.add("active");
          }
        });
      }
    });
  </script>
</body>
</html>
