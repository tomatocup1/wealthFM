<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>단골을 만드는 리뷰 관리의 비법 - 부의 정석</title>
  
  <!-- React & ReactDOM (CDN) -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>

  <!-- Babel (in-browser) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Supabase (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://xyzysbfukemhbmprtzto.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh5enlzYmZ1a2VtaGJtcHJ0enRvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzYxNTg4NjIsImV4cCI6MjA1MTczNDg2Mn0.DTRZM9WcXNhILGGGL4BJR40-snEh6Fna008hAGsExbY";
    window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>

  <!-- 폰트 (선택사항) -->
  <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">

  <style>
    /* ===== 1. CSS 변수 & 기본 스타일 ===== */
    :root {
      --primary-color: #FFB6C1;
      --secondary-color: #FFF0F5;
      --accent-color: #1b2024;
      --text-color: #1f1010;
      --heading-color: #1b2024;
      --background-color: #FFFAF0;
      --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
      --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
      --border-radius: 0.5rem;
      --spacing-sm: 0.5rem;
      --spacing-md: 1rem;
      --spacing-lg: 1.5rem;
    }

    body {
      font-family: 'Arial', sans-serif;
      background-color: var(--background-color);
      margin: 0;
      padding: 0;
      line-height: 1.6;
    }

    /* ===== 2. 네비게이션 ===== */
    /* 네비게이션 바 기본 스타일 */
    .navbar {
        background-color: #ffffff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        position: fixed;
        width: 100%;
        top: 0;
        z-index: 1000;
    }

    .nav-content {
        max-width: 1200px;
        margin: 0 auto;
        padding: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .nav-brand {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--heading-color);
    }

    /* 햄버거 메뉴 버튼 스타일 */
    .hamburger-menu {
        display: none;
        background: none;
        border: none;
        padding: 0.5rem;
        cursor: pointer;
        color: var(--text-color);
    }

    /* 네비게이션 메뉴 스타일 */
    .nav-menu {
        display: flex;
        gap: 2rem;
    }

    .nav-link {
        text-decoration: none;
        color: var(--text-color);
        padding: 0.5rem;
        font-size: 1.1rem;
    }

    .nav-link:hover {
        color: var(--accent-color);
    }

    .nav-link.active {
        color: var(--accent-color);
        border-bottom: 2px solid var(--accent-color);
    }

    .role-select {
        padding: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-family: 'Arial', sans-serif;
    }

    /* ===== 3. 메인 콘텐츠 ===== */
    .main-content {
      margin-top: 80px;
      padding: var(--spacing-lg);
      max-width: 1200px;
      margin-left: auto;
      margin-right: auto;
    }

    .dashboard-container {
      background: white;
      border-radius: var(--border-radius);
      padding: var(--spacing-lg);
      box-shadow: var(--shadow-md);
    }

    /* 달력 관련 */
    .calendar {
      background: white;
      padding: var(--spacing-md);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-md);
      margin-bottom: var(--spacing-lg);
    }
    .calendar td, .calendar th {
      text-align: center;
      border: 1px solid #eee;
      padding: 8px;
    }
    .calendar td:hover {
      background-color: #f0f0f0;
      cursor: pointer;
    }
    .calendar td.selected {
      background-color: var(--accent-color);
      color: #fff;
    }
    /* 모바일 반응형 스타일 */
    @media (max-width: 768px) {
        .hamburger-menu {
            display: block;
            position: relative;
            z-index: 100;
        }

        .nav-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background-color: #ffffff;
            padding: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .nav-menu.active {
            display: block;
        }

        .nav-link {
            display: block;
            width: 100%;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #eee;
        }

        .nav-link:hover,
        .nav-link.active {
            background-color: var(--accent-color);
            color: white;
        }

        .nav-link:last-child {
            border-bottom: none;
        }
    

        .role-select {
            font-size: 14px;
        }
    }
      .main-content {
        padding: var(--spacing-sm);
      }
    }

    @media (max-width: 480px) {
      /* 필요하면 추가 반응형 */
    }
  </style>
</head>

<body>
<!-- 네비게이션 바 -->
  <nav class="navbar">
    <div class="nav-content">
        <!-- 로고 -->
        <div class="nav-brand">부의 정석</div>

        <!-- 햄버거 메뉴 버튼 -->
        <button type="button" class="hamburger-menu" aria-label="메뉴 열기">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
        </button>

        <!-- 네비게이션 메뉴 -->
        <div class="nav-menu" id="navMenu">
            <a href="layout.html" class="nav-link">리뷰 모아보기</a>
            <a href="customer_data.html" class="nav-link">고객 데이터 관리</a>
            <a href="error_logs.html" class="nav-link">에러 로그</a>
        </div>

        <!-- 역할 선택 -->
        <select class="role-select" id="roleSelect">
            <option value="webmaster">웹마스터</option>
            <option value="admin">관리자</option>
            <option value="franchise">프랜차이즈</option>
            <option value="owner">점주님</option>
        </select>
    </div>
  </nav>

  <!-- 메인 콘텐츠 영역 -->
  <main class="main-content">
    <div id="review-dashboard-root"></div>
  </main>

  <!-- React 코드 -->
  <script type="text/babel">
    const { useState, useEffect } = React;

    function formatRawTime(isoString) {
      if (!isoString) return '';
      let s = isoString.replace('T', ' ');
      s = s.replace('.000Z', '');
      s = s.replace('Z', '');
      return s.trim();
    }

    // 리뷰 카드 컴포넌트
    function ReviewCard({ review }) {
      const renderStars = (rating) => {
        return "⭐".repeat(rating);
      };

      const getPlatformColor = (platform) => {
        switch(platform) {
          case "배민": return "bg-blue-100";
          case "쿠팡": return "bg-orange-100";
          case "요기요": return "bg-red-100";
          default: return "bg-gray-100";
        }
      };

      return (
        <div className="bg-white rounded-2xl p-6 shadow-lg hover:shadow-xl transition-shadow duration-300 border border-gray-100">
          <div className="flex items-center justify-between mb-4">
            <div className="flex items-center gap-3">
              <span className="font-bold text-lg text-gray-800">
                {review.store_name}
              </span>
              <span className={`px-3 py-1 rounded-full text-sm ${getPlatformColor(review.platform)}`}>
                {review.platform}
              </span>
              {review.reviewer && (
                <span className="text-blue-600 bg-blue-50 px-3 py-1 rounded-full text-sm">
                  {review.reviewer}
                </span>
              )}
            </div>
            <span className="text-gray-600">
              {formatRawTime(review.created_at)}
            </span>
          </div>

          <div className="mb-3 text-xl">
            {renderStars(review.star_rating)}
            <span className="ml-2 text-sm text-gray-600">
              {review.star_rating}점
            </span>
          </div>

          <div className="mb-3 px-4 py-2 bg-purple-50 rounded-full inline-block">
            🍽️ {review.order_menu}
          </div>

          <div className="my-4 text-gray-700 bg-gray-50 p-4 rounded-xl whitespace-pre-line">
            {review.review_text}
          </div>

          {review.ai_reply && (
            <div className="mt-4 p-4 bg-yellow-50 rounded-xl border border-yellow-100">
              <div className="flex items-center gap-2 mb-2">
                <span className="text-yellow-600 font-bold">💌 사장님 답글</span>
              </div>
              <div className="text-gray-700 whitespace-pre-line">
                {review.ai_reply}
              </div>
            </div>
          )}
        </div>
      );
    }

    // 전체 대시보드
    function ReviewDashboard() {
      const [stores, setStores] = useState([]);
      const [reviews, setReviews] = useState([]);
      const [filteredReviews, setFilteredReviews] = useState([]);
      const [selectedStore, setSelectedStore] = useState("all");
      const [selectedPlatform, setPlatform] = useState("all");
      const [selectedDate, setSelectedDate] = useState(new Date());
      const [selectedRating, setSelectedRating] = useState("all");
      const [userRole, setUserRole] = useState("");
      const [statistics, setStatistics] = useState({
        total: 0,
        ratings: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 }
      });
      const [loading, setLoading] = useState(true);
      const [currentMonth, setCurrentMonth] = useState(new Date());
      const [selectedDay, setSelectedDay] = useState(new Date());

      // 페이지 로드 시: 사용자 정보 & 가게 목록
      useEffect(() => {
        const userInfo = sessionStorage.getItem("userInfo");
        if (userInfo) {
          const parsed = JSON.parse(userInfo);
          setUserRole(parsed.role);
          loadStores(parsed.role, parsed.id);
        }
      }, []);

      // 가게 목록 로드 
      async function loadStores(role, userId) {
        try {
          let query = window.supabase
            .from("customer_data")
            .select("store_code, store_name");

          switch (role) {
            case "admin":
              query = query.eq("admin_id", userId);
              break;
            case "franchise":
              query = query.eq("franchise_id", userId);
              break;
            case "owner":
              query = query.eq("store_code", userId);
              break;
            default:
              break;
          }

          const { data, error } = await query.order("store_name");
          if (error) throw error;
          setStores(data || []);
        } catch (err) {
          console.error("가게 목록 로드 실패:", err);
        }
      }

      // 달력 생성
      function generateCalendar(date) {
        const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
        const lastDay = new Date(date.getFullYear(), date.getMonth() + 1, 0);
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - startDate.getDay());

        const weeks = [];
        let currentWeek = [];

        for (let day = new Date(startDate); day <= lastDay; day.setDate(day.getDate() + 1)) {
          if (currentWeek.length === 7) {
            weeks.push(currentWeek);
            currentWeek = [];
          }
          currentWeek.push(new Date(day));
        }

        while (currentWeek.length < 7) {
          const nextDay = new Date(currentWeek[currentWeek.length - 1]);
          nextDay.setDate(nextDay.getDate() + 1);
          currentWeek.push(nextDay);
        }
        weeks.push(currentWeek);

        return weeks;
      }

      // 날짜 클릭
      function handleDateSelect(date) {
        setSelectedDay(date);
        setSelectedDate(date);
        loadReviews(date);
      }

      // 별점 필터 핸들러
      const handleRatingFilter = (rating) => {
        setSelectedRating(rating);
        if (rating === 'all') {
          setFilteredReviews(reviews);
        } else {
          const filtered = reviews.filter(review => 
            parseInt(review.star_rating) === parseInt(rating)
          );
          setFilteredReviews(filtered);
        }
      };

      // 리뷰 로드
      useEffect(() => {
        loadReviews(selectedDate);
      }, [selectedStore, selectedPlatform]);

      async function loadReviews(date) {
        try {
          setLoading(true);
          const startOfDay = new Date(date.getFullYear(), date.getMonth(), date.getDate(), 0, 0, 0);
          const endOfDay = new Date(date.getFullYear(), date.getMonth(), date.getDate(), 23, 59, 59);
          const startUtc = startOfDay.toISOString();
          const endUtc = endOfDay.toISOString();

          let query = window.supabase
            .from("review_data")
            .select("*")
            .gte("created_at", startUtc)
            .lte("created_at", endUtc);

          if (selectedStore !== "all") {
            query = query.eq("store_code", selectedStore);
          }
          if (selectedPlatform !== "all") {
            query = query.eq("platform", selectedPlatform);
          }

          const { data, error } = await query;
          if (error) throw error;

          const reviewData = data || [];
          setReviews(reviewData);
          handleRatingFilter(selectedRating);
          updateStatistics(reviewData);
        } catch (err) {
          console.error("리뷰 로드 실패:", err);
        } finally {
          setLoading(false);
        }
      }

      // 별점 통계
      function updateStatistics(reviewData) {
        const newStats = {
          total: reviewData.length,
          ratings: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 }
        };
        
        reviewData.forEach((r) => {
          const rating = parseInt(r.star_rating, 10);
          if (rating >= 1 && rating <= 5) {
            newStats.ratings[rating] += 1;
          }
        });
        
        setStatistics(newStats);
      }

      function formatDate(date) {
        return new Date(date).toLocaleDateString("ko-KR", {
          year: "numeric",
          month: "long",
          day: "numeric"
        });
      }

      return (
        <div className="dashboard-container p-6">
          {/* 달력 섹션 */}
          <div className="bg-white rounded-lg p-6 shadow-md mb-6">
            <h2 className="text-xl font-bold mb-4">날짜 선택</h2>
            <div className="mb-4 flex justify-between items-center">
              <button
                onClick={() => {
                  const prev = new Date(currentMonth);
                  prev.setMonth(prev.getMonth() - 1);
                  setCurrentMonth(prev);
                }}
                className="px-4 py-2 bg-gray-100 rounded hover:bg-gray-200"
              >
                이전 달
              </button>
              <div className="text-lg font-bold">
                {currentMonth.toLocaleDateString("ko-KR", {
                  year: "numeric",
                  month: "long",
                })}
              </div>
              <button
                onClick={() => {
                  const next = new Date(currentMonth);
                  next.setMonth(next.getMonth() + 1);
                  setCurrentMonth(next);
                }}
                className="px-4 py-2 bg-gray-100 rounded hover:bg-gray-200"
              >
                다음 달
              </button>          
            </div>

            <div className="grid grid-cols-7 gap-1">
              {["일","월","화","수","목","금","토"].map((day) => (
                <div key={day} className="text-center font-bold py-2">
                  {day}
                </div>
              ))}
              {generateCalendar(currentMonth).flat().map((dateObj, idx) => {
              const isCurrentMonth = (dateObj.getMonth() === currentMonth.getMonth());
              const isSelected = (dateObj.toDateString() === selectedDay.toDateString());
              return (
                <div
                  key={idx}
                  onClick={() => handleDateSelect(dateObj)}
                  className={`
                    text-center p-2 cursor-pointer rounded
                    ${isCurrentMonth ? "text-gray-800" : "text-gray-400"}
                    ${isSelected ? "bg-blue-500 text-white" : "hover:bg-gray-100"}
                  `}
                >
                  {dateObj.getDate()}
                </div>
              );
            })}
            </div>
            </div>

            {/* 가게 선택 (owner 제외) */}
            {userRole !== "owner" && (
              <select
                className="w-full p-2 mb-4 border rounded"
                value={selectedStore}
                onChange={(e) => setSelectedStore(e.target.value)}
              >
                <option value="all">전체 가게</option>
                {stores.map((store) => (
                  <option key={store.store_code} value={store.store_code}>
                    {store.store_name}
                  </option>
                ))}
              </select>
            )}

            {/* 별점 통계 및 필터 */}
            <div className="bg-white rounded-lg p-6 shadow-md mb-6">
              <h2 className="text-xl font-bold mb-4">별점 통계</h2>
              <div className="grid grid-cols-6 gap-4">
                {/* 전체(통합) 통계 */}
                <button
                  onClick={() => handleRatingFilter('all')}
                  className={`text-center p-4 rounded-lg transition-all duration-200 ${
                    selectedRating === 'all' 
                      ? 'bg-gray-800 text-white' 
                      : 'bg-gray-50 hover:bg-gray-100'
                  }`}
                >
                  <div className="text-2xl font-bold">{statistics.total}</div>
                  <div className="text-gray-600">통합</div>
                </button>
                
                {/* 각 별점 통계 */}
                {[5,4,3,2,1].map(rating => (
                  <button
                    key={rating}
                    onClick={() => handleRatingFilter(rating)}
                    className={`text-center p-4 rounded-lg transition-all duration-200 ${
                      selectedRating === rating.toString()
                        ? 'bg-gray-800 text-white'
                        : 'bg-gray-50 hover:bg-gray-100'
                    }`}
                  >
                    <div className="text-2xl font-bold">{statistics.ratings[rating]}</div>
                    <div className="text-gray-600">{rating}점</div>
                  </button>
                ))}
              </div>
            </div>

            {/* 플랫폼 필터 */}
            <div className="flex gap-4 mb-6">
              {['all', '배민', '쿠팡', '요기요'].map(platform => (
                <button 
                  key={platform}
                  onClick={() => setPlatform(platform)}
                  className={`px-4 py-2 rounded-lg ${
                    selectedPlatform === platform 
                      ? 'bg-gray-800 text-white' 
                      : 'bg-white'
                  }`}
                >
                  {platform === 'all' ? '전체' : platform}
                </button>
              ))}
            </div>

            {/* 리뷰 목록 */}
            <div className="space-y-4">
              <h3 className="text-lg font-bold mb-4">
                {formatDate(selectedDate)} 리뷰
                {selectedRating !== 'all' && ` (${selectedRating}점)`}
              </h3>
              {loading ? (
                <div className="text-center py-8">데이터를 불러오는 중...</div>
              ) : filteredReviews.length === 0 ? (
                <div className="text-center py-8">리뷰가 없습니다.</div>
              ) : (
                filteredReviews.map((review, index) => (
                  <ReviewCard key={index} review={review} />
                ))
              )}
            </div>
            </div>
            );
            }

            // 렌더링
            const rootElement = document.getElementById("review-dashboard-root");
            const root = ReactDOM.createRoot(rootElement);
            root.render(<ReviewDashboard />);
            </script>

            <!-- 네비게이션 권한 관리 -->
            <script>
            document.addEventListener("DOMContentLoaded", function () {
              const userRaw = sessionStorage.getItem("userInfo") || "{}";
              let userInfo;
              try {
                userInfo = JSON.parse(userRaw);
              } catch(e) {
                userInfo = {};
              }

              const navMenu = document.getElementById("navMenu");

              // 로그인 안 되어 있으면 login.html로
              if (!userInfo.role) {
                window.location.href = "login.html";
              } else {
                updateMenuByRole(userInfo.role);
              }

              function updateMenuByRole(role) {
                let menuLinks = `<a href="layout.html" class="nav-link">리뷰 모아보기</a>`;
                if (role === "webmaster" || role === "admin") {
                  menuLinks += `<a href="customer_data.html" class="nav-link">고객 데이터 관리</a>`;
                }
                if (role === "webmaster") {
                  menuLinks += `<a href="error_logs.html" class="nav-link">에러 로그</a>`;
                }

                navMenu.innerHTML = menuLinks;

                // 현재 페이지 활성화
                const currentPage = window.location.pathname.split("/").pop();
                const menuItems = navMenu.querySelectorAll(".nav-link");
                menuItems.forEach((item) => {
                  if (item.getAttribute("href") === currentPage) {
                    item.classList.add("active");
                  }
                });
              }
            });
            </script>
          <!-- 햄버거 메뉴 스크립트 추가 -->
          <script>
            document.addEventListener('DOMContentLoaded', function() {
                // 햄버거 메뉴 요소 선택
                const hamburgerBtn = document.querySelector('.hamburger-menu');
                const navMenu = document.querySelector('.nav-menu');

                // 햄버거 메뉴 클릭 이벤트
                if (hamburgerBtn) {
                    hamburgerBtn.addEventListener('click', function() {
                        navMenu.classList.toggle('active');
                    });
                }

                // 화면 크기 변경 시 메뉴 초기화
                window.addEventListener('resize', function() {
                    if (window.innerWidth > 768) {
                        navMenu.classList.remove('active');
                    }
                });

                // 메뉴 외부 클릭시 닫기
                document.addEventListener('click', function(e) {
                    if (!navMenu.contains(e.target) && !hamburgerBtn.contains(e.target)) {
                        navMenu.classList.remove('active');
                    }
                });
            });
          </script>
            </body>
            </html>